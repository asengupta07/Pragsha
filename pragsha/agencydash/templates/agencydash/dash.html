{% extends 'agencydash/layout.html' %}

{% block title %}
Dashboard
{% endblock %}

{% block links %}
<script type="text/javascript">
    function initMap() {
        var map = new Microsoft.Maps.Map(document.getElementById('map'), {
            credentials: 'AoCUncNX_-l6FfT1nHyketx4jOn1zrAIiBzGfYei8zgT9CUyVqxRckBBMZYI18Zx'
        });

        // Add a pushpin for the user's location
        navigator.geolocation.getCurrentPosition(function (position) {
            var userLocation = new Microsoft.Maps.Location(position.coords.latitude, position.coords.longitude);
            var userPushpin = new Microsoft.Maps.Pushpin(userLocation, { color: 'green', title: 'YOU' });
            map.entities.push(userPushpin);
        });

        // Parse the JSON data passed from the view
        var markerData = JSON.parse('{{ marker_data|safe }}');
        var zones = JSON.parse('{{ zones|safe }}');

        for (var i = 0; i < markerData.length; i++) {
            var location = new Microsoft.Maps.Location(markerData[i].latitude, markerData[i].longitude);
            var pushpin = new Microsoft.Maps.Pushpin(location, { color: 'red', title: markerData[i].name, text: `${markerData[i].id}` });
            map.entities.push(pushpin);
        }
        Microsoft.Maps.loadModule("Microsoft.Maps.SpatialMath", function () {
        for (var i = 0; i < zones.length; i++) {
            var loc = new Microsoft.Maps.Location(zones[i].centroid[0], zones[i].centroid[1]);

            //Create an accuracy circle
            var path = Microsoft.Maps.SpatialMath.getRegularPolygon(loc, zones[i].radius*110, 36,  Microsoft.Maps.SpatialMath.Meters);
            var poly = new Microsoft.Maps.Polygon(path);
            map.entities.push(poly);

            //Add a pushpin at the user's location.
            var pin = new Microsoft.Maps.Pushpin(loc);
            map.entities.push(pin);
        }
    });
        
    }
</script>
<script id="api" type='text/javascript'
    src='http://www.bing.com/api/maps/mapcontrol?callback=initMap' async defer></script>
{% endblock %}

{% block main %}

<div class="container">
    <div class="card">
        <div class="card-body">
            <h3 class="card-title">Map</h3>
            <div id="map" style="width: 100%; height: 400px;"></div>
        </div>
    </div>
    <div class="card mt-3">
        <div class="card-body">
            <h3 class="card-title">Disasters</h3>
            <table id="agencyTable" class="table table-striped">
                <thead class="thead-dark">
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Location</th>
                        <th>Accept Mission</th>
                    </tr>
                </thead>
                <tbody id="agencyTableBody">
                    {% for disaster in disasters %}
                    <tr>
                        <td>{{ disaster.id }}</td>
                        <td>{{ disaster.type }}</td>
                        <td>{{ disaster.address }}</td>
                        <td>
                            <form action="/agency/dashboard/response/" method="post">
                                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                <input type="hidden" name="id" value="{{ disaster.id }}">
                                <input type="hidden" name="address" value="{{ disaster.address }}">
                                <button type="submit" class="btn btn-success">Accept</button>
                            </form>
                        </td>
                        <!-- <td><a href=" url 'agencydash:accept' disaster.id">Accept</a></td> -->
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<div id="result" style="margin-top: 20px;"></div>
</div>
{% endblock %}