{% extends 'agencydash/layout.html' %}

{% block title %}
Mission
{% endblock %}

{% block links %}
<script type='text/javascript' src='http://www.bing.com/api/maps/mapcontrol?callback=initMap' async defer></script>
{% endblock %}

{% block main %}

<div class="container">
    <div class="card">
        <div class="card-body">
            <h3 class="card-title">Mission Details</h3>
            <div class="row">
                <div class="col">
                    <p><b>ID:</b> {{ mission.id }}</p>
                    <p><b>Name:</b> {{ mission.name }}</p>
                </div>
                <div class="col">
                    <p><b>Timestamp:</b> {{ mission.timestamp }}</p>
                    <p><b>Type:</b> {{ mission.type }}</p>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <p><b>Latitude:</b> {{ mission.latitude }}</p>
                    <p><b>Longitude:</b> {{ mission.longitude }}</p>
                </div>
                <div class="col">
                    <p><b>Address:</b> {{ mission.address }}</p>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <h3 class="card-title">Map</h3>
            <div id="map" style="width: 100%; height: 400px;"></div>
        </div>
    </div>
    <div class="row">
        <!-- Filter Column -->
        <div class="col-md-3">
            <div class="card mt-3">
                <div class="card-body">
                    <h3 class="card-title">Filters:</h3>
                    <!-- Filter by Department Dropdown -->
                    <div class="form-group">
                        <label for="deptFilter">Filter by Department:</label>
                        <select id="deptFilter" class="form-control">
                            <option value="All">All</option>
                            {% for dept in available_departments %}
                            <option value="{{ dept.value }}">{{ dept.key }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <!-- Map Column -->
        <div class="col-md-9">
            <!-- Agency Table -->
            <div class="card mt-3">
                <div class="card-body">
                    <h3 class="card-title">Agency Table</h3>
                    <table id="agencyTable" class="table table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Departments</th>
                                <th>Specializations</th>
                                <th>Contact</th>
                            </tr>
                        </thead>
                        <tbody id="agencyTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    function initMap() {
        var map = new Microsoft.Maps.Map(document.getElementById('map'), {
            credentials: 'AoCUncNX_-l6FfT1nHyketx4jOn1zrAIiBzGfYei8zgT9CUyVqxRckBBMZYI18Zx'
        });

        var emergencyLocation = JSON.parse('{{ emergency|safe }}');
        var mylat;
        var mylong;

        navigator.geolocation.getCurrentPosition(function (position) {
            mylat = position.coords.latitude;
            mylong = position.coords.longitude;
        });

        Microsoft.Maps.loadModule('Microsoft.Maps.Directions', function () {
                //Create an instance of the directions manager.
                directionsManager = new Microsoft.Maps.Directions.DirectionsManager(map);

                //Create waypoints to route between.
                var seattleWaypoint = new Microsoft.Maps.Directions.Waypoint({ address: 'YOU', location: new Microsoft.Maps.Location(mylat, mylong) });
                directionsManager.addWaypoint(seattleWaypoint);

                var workWaypoint = new Microsoft.Maps.Directions.Waypoint({ address: 'SOS', location: new Microsoft.Maps.Location(emergencyLocation.latitude, emergencyLocation.longitude) });
                directionsManager.addWaypoint(workWaypoint);

                //Specify the element in which the itinerary will be rendered.
                directionsManager.setRenderOptions({ routeMode: Microsoft.Maps.Directions.RouteMode.driving });

                //Calculate directions.
                directionsManager.calculateDirections();
            });
            navigator.geolocation.getCurrentPosition(function (position) {
                var userLocation = new Microsoft.Maps.Location(position.coords.latitude, position.coords.longitude);
                var userPushpin = new Microsoft.Maps.Pushpin(userLocation, { color: 'green', title: 'YOU' });
                map.entities.push(userPushpin);
            });

        var markerData = JSON.parse('{{ marker_data|safe }}');
        for (var i = 0; i < markerData.length; i++) {
            var location = new Microsoft.Maps.Location(markerData[i].latitude, markerData[i].longitude);
            var pushpin = new Microsoft.Maps.Pushpin(location, { color: 'blue', title: markerData[i].name, text: `${markerData[i].id}` });
            map.entities.push(pushpin);
        }
        var location = new Microsoft.Maps.Location(emergencyLocation.latitude, emergencyLocation.longitude);
        var pushpin = new Microsoft.Maps.Pushpin(location, { color: 'red', title: 'SOS' });
        map.entities.push(pushpin);
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const deptFilter = document.getElementById("deptFilter");
        const agencyTableBody = document.getElementById("agencyTableBody"); // Updated to target the table body
        const ags = {{ ags | safe }};

    // Function to filter agencies based on department
    function filterAgenciesByDept(dept) {
        return ags.filter(agency => {
            if (dept === "All") {
                return true; // Show all agencies when "All" is selected
            } else {
                return agency.depts.includes(dept);
            }
        });
    }

    // Function to render filtered agencies
    function renderFilteredAgencies(filteredAgencies) {
        // Clear existing table rows
        agencyTableBody.innerHTML = "";
        filteredAgencies.forEach(agency => {
            const agencyElement = document.createElement("tr");
            agencyElement.innerHTML = `
                    <td>${agency.id}</td>
                    <td>${agency.name}</td>
                    <td>${agency.email}</td>
                    <td>Departments: ${agency.depts.join(', ')}</td>
                    <td>${agency.specs}</td>
                    <td></td>
                `;
            agencyTableBody.appendChild(agencyElement); // Append the <tr> to the table body
        });
    }

    // Event listener for department select change
    deptFilter.addEventListener("change", function () {
        const selectedDept = deptFilter.value;
        const filteredAgencies = filterAgenciesByDept(selectedDept);
        renderFilteredAgencies(filteredAgencies);
    });

    // Initialize with all agencies
    renderFilteredAgencies(ags);
    });
</script>



<div id="result" style="margin-top: 20px;"></div>
</div>
{% endblock %}