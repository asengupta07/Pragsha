{% extends 'agencydash/layout.html' %}

{% block title %}
Map
{% endblock %}

{% block links %}
<script type='text/javascript'
    src='https://www.bing.com/api/maps/mapcontrol?key=AoCUncNX_-l6FfT1nHyketx4jOn1zrAIiBzGfYei8zgT9CUyVqxRckBBMZYI18Zx'></script>

{% endblock %}

{% block main %}
<div id="map" style="width: 100%; height: 400px;"></div>

<!-- Table for Agencies -->
<h3>Filters:</h3>
<!-- Add this to your HTML template -->
<label for="deptFilter">Filter by Department:</label>
<!-- Modify the select element in your HTML template -->
<select id="deptFilter">
    <option value="All">All</option>
    {% for dept in available_departments %}
    <option value="{{ dept.value }}">{{ dept.key }}</option>
    {% endfor %}
</select>

<!-- Add this to your HTML template -->
<table id="agencyTable" class="table table-striped">
    <thead class="thead-dark">
        <tr>
            <th>
                <h5>Name</h5>
            </th>
            <th>
                <h5>Email</h5>
            </th>
            <th>
                <h5>Departments</h5>
            </th>
            <th>
                <h5>Specializations</h5>
            </th>
            <th>
                <h5>Contact</h5>
            </th>
        </tr>
    </thead>
    <tbody id="agencyTableBody">
    </tbody>
</table>

<script>
    function initMap() {
        var map = new Microsoft.Maps.Map(document.getElementById('map'), {
            credentials: 'AoCUncNX_-l6FfT1nHyketx4jOn1zrAIiBzGfYei8zgT9CUyVqxRckBBMZYI18Zx'
        });

        // Add a pushpin for the user's location
        navigator.geolocation.getCurrentPosition(function (position) {
            var userLocation = new Microsoft.Maps.Location(position.coords.latitude, position.coords.longitude);
            var userPushpin = new Microsoft.Maps.Pushpin(userLocation, { color: 'green', title: '{{ agency_name|safe }}' });
            map.entities.push(userPushpin);
        });

        // Parse the JSON data passed from the view
        var markerData = JSON.parse('{{ marker_data|safe }}');

        for (var i = 0; i < markerData.length; i++) {
            var location = new Microsoft.Maps.Location(markerData[i].latitude, markerData[i].longitude);
            var pushpin = new Microsoft.Maps.Pushpin(location, { title: markerData[i].name });
            map.entities.push(pushpin);
        }

        var yellowMarkerData = JSON.parse('{{ yellow_marker_data|safe }}');

        for (var i = 0; i < yellowMarkerData.length; i++) {
            var yellowLocation = new Microsoft.Maps.Location(yellowMarkerData[i].latitude, yellowMarkerData[i].longitude);
            var yellowPushpin = new Microsoft.Maps.Pushpin(yellowLocation, { color: 'yellow', title: yellowMarkerData[i].name });
            map.entities.push(yellowPushpin);
        }
    }

    Microsoft.Maps.loadModule('Microsoft.Maps.AutoSuggest', { callback: initMap, errorCallback: function (e) { console.log(e); } });
</script>
<!-- Add this JavaScript code to your HTML template -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const deptFilter = document.getElementById("deptFilter");
        const agencyTableBody = document.getElementById("agencyTableBody"); // Updated to target the table body
        const ags = {{ ags|safe }};

        // Function to filter agencies based on department
        function filterAgenciesByDept(dept) {
            return ags.filter(agency => {
                if (dept === "All") {
                    return true; // Show all agencies when "All" is selected
                } else {
                    return agency.depts.includes(dept);
                }
            });
        }

        // Function to render filtered agencies
        function renderFilteredAgencies(filteredAgencies) {
            // Clear existing table rows
            agencyTableBody.innerHTML = "";
            filteredAgencies.forEach(agency => {
                const agencyElement = document.createElement("tr");
                agencyElement.innerHTML = `
                    <td>${agency.name}</td>
                    <td>${agency.email}</td>
                    <td>Departments: ${agency.depts.join(', ')}</td>
                    <td>${agency.specs}</td>
                    <td></td>
                `;
                agencyTableBody.appendChild(agencyElement); // Append the <tr> to the table body
            });
        }

        // Event listener for department select change
        deptFilter.addEventListener("change", function () {
            const selectedDept = deptFilter.value;
            const filteredAgencies = filterAgenciesByDept(selectedDept);
            renderFilteredAgencies(filteredAgencies);
        });

        // Initialize with all agencies
        renderFilteredAgencies(ags);
    });
</script>



<div id="result" style="margin-top: 20px;"></div>
</div>
{% endblock %}