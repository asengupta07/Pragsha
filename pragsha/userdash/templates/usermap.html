<!DOCTYPE html>
<html lang="en">
{% load pwa %}
{% load static %}

<head>
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({ pageLanguage: 'en', layout: google.translate.TranslateElement.FloatPosition.TOP_LEFT }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript"
        src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    {% progressive_web_app_meta %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forum</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        .card {
            background-color: #fff6ef;
        }

        body {
            background: -webkit-linear-gradient(to right, #ffffff, #ffb78f);
            background: linear-gradient(to right, #ffffff, #ffb78f);
        }


        img {
            filter: drop-shadow(2px 2px 1px #000);
        }

        #fixed-button-2 {
            position: fixed;
            /* Set the position to fixed */
            bottom: 20px;
            /* Adjust the distance from the bottom */
            left: 20px;
            /* Adjust the distance from the right */
            z-index: 999;
            /* Ensure it's on top of other content */
        }

        /* Style the button as desired */
        #fixed-button-2 button {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }
    </style>
    <script type='text/javascript' src='http://www.bing.com/api/maps/mapcontrol?callback=initMap' async defer></script>
</head>

<body>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            // Simulate a click on the Google Translate element to trigger translation.
            setTimeout(function () {
                $('#google_translate_element > div > div > div > div > a').trigger('click');
            }, 2000); // Adjust the delay (in milliseconds) as needed.
        });
    </script>
    <!-- Button trigger modal -->
    <div id="fixed-button-2">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
            Translate
        </button>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Translate</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="google_translate_element"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Save</button>
                </div>
            </div>
        </div>
    </div>
    <nav class="navbar navbar-expand-lg sticky-top" style="background-color: #ffb78f;">
        <div class="container-fluid">
            <a class="me-3" href="/"><img src="{% static 'wreath.png' %}" alt="logo" width="50px"></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item ms-3 me-3 text-center">
                        <a class="nav-link active" aria-current="page" href="#"><b>Home</b></a>
                    </li>
                    <li class="nav-item ms-3 me-3 text-center">
                        <a class="nav-link" href="/user/sos/"><b>SOS</b></a>
                    </li>

                    <li class="nav-item ms-3 me-3 text-center">
                        <a class="nav-link" href="/user/forum/"><b>Forum</b></a>
                    </li>
                    <li class="nav-item ms-3 me-3 text-center">
                        <a class="nav-link" href="/user/chatbot/"><b>PragshaGPT</b></a>
                    </li>
                </ul>
                <ul class="navbar-nav me-2">
                    <li class="nav-item ms-3 me-3 text-center">
                        <a class="nav-link" href="/user/logout"><b>Log Out</b></a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <br>
    <div class="container">

        <div class="card">
            <div class="card-body">
                <h3 class="card-title">Map</h3>
                <div id="map" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
        <div class="row">
            <!-- Filter Column -->
            <div class="col-md-3">
                <div class="card mt-3">
                    <div class="card-body">
                        <h3 class="card-title">Filters:</h3>
                        <!-- Filter by Department Dropdown -->
                        <div class="form-group">
                            <label for="deptFilter">Filter by Department:</label>
                            <select id="deptFilter" class="form-control">
                                <option value="All">All</option>
                                {% for dept in available_departments %}
                                <option value="{{ dept.value }}">{{ dept.key }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Map Column -->
            <div class="col-md-9">
                <!-- Agency Table -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h3 class="card-title">Agencies Near You:</h3>
                        <div class="table-responsive">
                            <table id="agencyTable" class="table table-striped">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Departments</th>
                                        <th>Specializations</th>
                                        <th>Contact</th>
                                    </tr>
                                </thead>
                                <tbody id="agencyTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <script>
        function initMap() {
            var map = new Microsoft.Maps.Map(document.getElementById('map'), {
                credentials: 'AoCUncNX_-l6FfT1nHyketx4jOn1zrAIiBzGfYei8zgT9CUyVqxRckBBMZYI18Zx'
            });
            var mylat;
            var mylong;

            navigator.geolocation.getCurrentPosition(function (position) {
                mylat = position.coords.latitude;
                mylong = position.coords.longitude;
            });
            navigator.geolocation.getCurrentPosition(function (position) {
                var userLocation = new Microsoft.Maps.Location(position.coords.latitude, position.coords.longitude);
                var userPushpin = new Microsoft.Maps.Pushpin(userLocation, { color: 'green', title: 'YOU' });
                map.entities.push(userPushpin);
            });

            var markerData = JSON.parse('{{ marker_data|safe }}');
            for (var i = 0; i < markerData.length; i++) {
                var location = new Microsoft.Maps.Location(markerData[i].latitude, markerData[i].longitude);
                var pushpin = new Microsoft.Maps.Pushpin(location, { color: 'blue', title: markerData[i].name, text: `${markerData[i].id}` });
                map.entities.push(pushpin);
            }
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const deptFilter = document.getElementById("deptFilter");
            const agencyTableBody = document.getElementById("agencyTableBody"); // Updated to target the table body
            const ags = {{ ags | safe }};

        // Function to filter agencies based on department
        function filterAgenciesByDept(dept) {
            return ags.filter(agency => {
                if (dept === "All") {
                    return true; // Show all agencies when "All" is selected
                } else {
                    return agency.depts.includes(dept);
                }
            });
        }

        // Function to render filtered agencies
        function renderFilteredAgencies(filteredAgencies) {
            // Clear existing table rows
            agencyTableBody.innerHTML = "";
            filteredAgencies.forEach(agency => {
                const agencyElement = document.createElement("tr");
                agencyElement.innerHTML = `
                    <td>${agency.agency_id}</td>
                    <td>${agency.name}</td>
                    <td>${agency.email}</td>
                    <td>${agency.depts.join(', ')}</td>
                    <td>${agency.specs}</td>
                    <td>
                            <button class="btn btn-primary" type="button">Contact</button>
                    </td>
                `;
                agencyTableBody.appendChild(agencyElement); // Append the <tr> to the table body
            });
        }

        // Event listener for department select change
        deptFilter.addEventListener("change", function () {
            const selectedDept = deptFilter.value;
            const filteredAgencies = filterAgenciesByDept(selectedDept);
            renderFilteredAgencies(filteredAgencies);
        });

        // Initialize with all agencies
        renderFilteredAgencies(ags);
    });
    </script>
    <div id="result" style="margin-top: 20px;"></div>
    </div>
</body>

</html>